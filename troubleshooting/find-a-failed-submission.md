---
category: Runner
expires: 2020-07-19
---

## Delayed Job Failures

Form Builder submissions are put onto a queue to be processed by the Submitter. Sometimes these can fail. They trigger a `FailedDelayedJob` alert which is sent to the #form-builder-alerts channel.

### Find the correct environment

Sometimes the environment the alert ocurred in does not get outputted to Slack. You can check the Form Builder [Grafana dashboard](https://grafana.cloud-platform.service.justice.gov.uk/d/-hXgWMWWk/form-builder?orgId=1) to see where it occurred. Failed Submitter Delayed Jobs is the top left box. Toggle the `platform_env` and `deployment_env` to move between environments.

### Locate a Submitter API pod

Once you know which environment you need to check you can log into the required submitter api container:
~~~~~~~~
kubectl get pods -n formbuilder-platform-<platform_env>-<deployment_env>
~~~~~~~~
E.g
~~~~~~~~
kubectl get pods -n formbuilder-platform-test-dev
~~~~~~~~
### Check the logs

Get the submitter api pod name from the list generated by the above commadn and then take a look at the logs from around the time of the alert:
~~~~~~~~
kubectl logs -n formbuilder-platform-live-dev fb-submitter-api-live-dev-<identifier>
~~~~~~~~
The `identifier` is generated when the pod is deployed so is different each time. The logs should hopefully give you an idea as to what happened.

### Check failure message in the Delayed Job

You can also log into one of the Submitter API pods and take a look at the error message attached to the failed Delayed Job
~~~~~~~~
kubectl exec -ti -n formbuilder-platform-test-dev fb-submitter-api-test-dev-<identifier>  -- bash
~~~~~~~~
Then run a Rails console:
~~~~~~~~
bundle exec rails c
~~~~~~~~

You can see the jobs that are currently stuck on the queue:

~~~~~~~~
Delayed::Job.all
~~~~~~~~

or if to narrow it down to just todays failed jobs:

~~~~~~~~
Delayed::Job.where(created_at: Time.zone.now.beginning_of_day..Time.zone.now.end_of_day)
~~~~~~~~

The output will show you the number of retries and also show the error message generated when the job failed.

You can also see the stack trace of the error:

~~~~~~~~
Delayed::Job.last.last_error
~~~~~~~~

### Replaying failed jobs

Once you are happy that it is ok to replay the failed job you will need to re-encrypt the payload of the Submission related to the Delayed Job.

For example if the Delayed Job you need to replay is the last one:

~~~~~~~~
submission_id = Delayed::Job.last.handler
~~~~~~~~

~~~~~~~~
submission = Submission.find_by_id(submission_id)
~~~~~~~~

The payload is encrypted. Unfortunately you will need to decrypt it before you can re-encrypt it again. At this point if you need to make any changes to the payload because it is invalid this would be time.

~~~~~~~~
submission.update(payload: EncryptionService.new.encrypt(submission.decrypted_payload))
~~~~~~~~

There are 3 rake tasks that can be run in order to replay Delayed Jobs. These will need to be run from outside the Rails console, but still on the Submitter container, in the normal way. One replays submissions without any attachments. So for a submission with the ID '12345':

~~~~~~~~
bundle exec rake replay_submissions:process[12345]
~~~~~~~~

You can also replay several submissions by separating them with spaces

~~~~~~~~
bundle exec rake replay_submissions:process[12345 67890]
~~~~~~~~

Another is for replaying submissions which have attachments. The filestore only validates JWT's that were created 60 seconds or less ago. So to replay any submissions with attachments after that we need to override the leeway using the rake task. So to override with a 8000 second leeway:

~~~~~~~~
bundle exec rake replay_submissions:with_attachments[12345,8000]
~~~~~~~~

As above you can use space separated IDs if you wish to replay more than one at a time.

All being well you will no longer see that Delayed Job in the queue any longer. Great success!

If for some reason you are running these rake tasks using zsh you need wrap the rake command in quotes:

~~~~~~~~
bundle exec rake 'replay_submissions:process[12345]'
~~~~~~~~

### Replaying failed HMCTS jobs

The HMCTS Adapter also has a queue where failed jobs sit. The adapter sits in its own namespace:

~~~~~~~~
kubectl get pods -n hmcts-complaints-formbuilder-adapter-staging
~~~~~~~~

And connect to a pod in the same way as the submitter:

~~~~~~~~
kubectl exec -ti -n hmcts-complaints-formbuilder-adapter-staging hmcts-complaints-formbuilder-adapter-api-staging-<identifier> -- bash
~~~~~~~~

You can then run a rake task to list the Submission IDs of the failed jobs:

~~~~~~~~
bundle exec rake list_failed_submission_ids
~~~~~~~~

These Submission IDs are the payload submission IDs that are generated by the Runner and stored in the JSON blob of the Submitter database. However the Submitter thinks of Submission IDs as the ID of the row of the table in the Submitter database.

Therefore to replay Submissions from the Submitter the task below needs to match the IDs passed in to ones inside the JSON payload:

~~~~~~~~
bundle exec rake replay_hmcts_adapter_submissions:process[12345 67890]
~~~~~~~~

This re-submits each Submission as a brand new Job to the HMCTS Adapter. In which case you should also delete the old ones on the Delayed::Job queue of the Adapter. The `list_failed_submission_id` also prints out the Job ID so you can use that to run: `Delayed::Job.delete(job_id)` from inside the Rails console. Carefully, of course!
